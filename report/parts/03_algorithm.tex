\chapter{Алгоритм функционирования}
В этой главе подробно описаны алгоритмы работы PAM модуля \emph{pam\_twofactor\_auth} и программы \emph{aes\_generate}.

\section{Алгоритм работы PAM модуля \emph{pam\_twofactor\_auth}}
\label{auth_algo}
Представленный алгоритм является реализацией функции \t{pam\_sm\_authenticate} (см. раздел~\ref{pam_sm_authenticate}).

Ниже приведены шаги алгоритма:
\begin{enumerate}
\item\label{step1} Получить имя пользователя функцией \t{pam\_get\_user}.
\item Узнать, используя файл \t{/etc/u2sn}, какому серийному номеру USB устройства соответствует имя пользователя. Если соответствие
для пользователя не задано или файл \t{/etc/u2sn} не существует, выдать об этом сообщение и перейти к шагу~\ref{step1}.
\item\label{step3} По серийному номеру USB устройства, вычислить какому блочному устройству оно соответствует (например, это может
быть \t{/dev/sdc}). Если USB устройство с требуемым серийным номером не обнаружено, выдать об этом сообщение и перейти к шагу~\ref{step1}.
\item Проверить, есть ли у полученного блочного устройства разделы (например, \t{/dev/sdc1}, \t{/dev/sdc2}). Если нет, то считать
разделом \t{/dev/sdc}.
\item\label{step5} Проверить в файле \t{/etc/mtab} примонтированы ли какие-нибудь разделы USB устройства. Если да, то на тех, которые
примонтированы проверить наличие файла \t{ptfa.key} в корне. Если этот файл будет обнаружен, прервать проверку и перейти к шагу~\ref{step7}.
Иначе, перейти к шагу~\ref{step6}.
\item\label{step6} По очереди монтировать непримонтированные разделы USB устройства, проверять наличие файла \t{ptfa.key} и отмонтировать.
\item\label{step7} Если на шаге~\ref{step5} или на шаге~\ref{step6} был обнаружен файл \t{ptfa.key}, прочитать его содержимое. Иначе
сообщить об ошибке аутентификации.
\item\label{step8} Запросить пароль (средствами PAM). Если введенным паролем не удастся расшифровать содержимое ключа (алгоритм расшифровки ключа
паролем смотреть в разделе~\ref{decrypt_key_with_passphrase}), повторить шаг~\ref{step8}. Максимальное число повторений ограничено константой. После
того, как попытки будут потрачены, заблокировать аутентификацию и завершить выполнение алгоритма. Если же содержимое ключа удастся расшифровать паролем,
то перейти к следующему шагу.
\item Задать расшифрованный паролем ключ в качестве \t{PAM\_AUTHTOK} (таким образом, следующий модуль аутентификации сможет использовать его в качестве
пароля). Разрешить аутентификацию.
\end{enumerate}

\subsection{Детали реализации шага~\ref{step3}}
Реализация данного шага для операционных систем МСВС 3.0 и Ubuntu различна.

\subsubsection{Детали реализации шага~\ref{step3}: МСВС 3.0}
\label{msvs_dev_by_sn_details}
Реализация шага~\ref{step3} алгоритма работы модуля \emph{pam\_twofactor\_auth} представлена отдельной функцией \t{getDeviceBySerialNumber\_MSVS30}. На
вход она принимает серийный номер устройства, а на выход выдаёт либо ошибку <<устройство не найдено>>, либо блочное устройство, которому соответствует
USB устройство с требуемым серийным номером.

Алгоритм работы этой функции следующий:
\begin{enumerate}
\item Прочитать содержимое файла \t{/proc/bus/usb/devices}. Если в нем отсутствует строка, имеющая вид \t{s:  serialnumber=<серийный\_номер>},
выдать ошибку <<устройство не найдено>> и завершить выполнение функции.
\item Перебирать все файлы, соответствующие маске \t{/proc/scsi/usb-storage-*/*}, и искать внутри них строку, имеющую вид \t{serial number: <серийный\_номер>}.
Как только файл с такой строкой будет обнаружен, прочитать в нем значение параметра \t{Host scsi} (оно может быть, например, \t{scsi1}) и перейти к следующему шагу.
\item Читать файл \t{/var/log/messages} с конца построчно (для этого была разработана специальная функция \t{getLineFromBack}) до тех пор, пока
не будет найдена строка, соответствующая маске:
\starttextblock
Attached scsi removable disk * at scsi <значение_параметра_из_шага_2>
\end{lstlisting}
\item Вернуть в качестве блочного устройства конкатенацию \t{/dev/} и того значения, которое будет соответствовать звездочке в приведенной выше маске.
\end{enumerate}

\subsubsection{Детали реализации шага~\ref{step3}: Ubuntu}
Реализация шага~\ref{step3} алгоритма работы модуля \emph{pam\_twofactor\_auth} представлена отдельной функцией \t{getDeviceBySerialNumber}. На
вход она принимает серийный номер устройства, а на выход выдаёт либо ошибку <<устройство не найдено>>, либо блочное устройство, которому соответствует
USB устройство с требуемым серийным номером.

Алгоритм работы функции \t{getDeviceBySerialNumber}:
\begin{enumerate}
\item Перебирать все файлы, содержащиеся в папке \t{/dev/disk/by-id}, и искать файл с названием \t{usb-<serial number>}.
\item Если такой файл не был найден, то выдать ошибку <<устройство не найдено>> и завершить выполнение функции.
\item Если такой файл был найден, то вернуть в качестве блочного устройства результат выполнения функции \t{readlink} (она читает, куда указывает
symbolic link).
\end{enumerate}

\section{Алгоритм работы программы \emph{aes\_generate}}
Приложение \emph{aes\_generate} принимает на вход пароль(\emph{passphrase}) и генерирует на выходе строку вида \emph{md5(<passphrase>+<key>)+aes(<key>)}
в \emph{base64}-формате, где <<+>> — конкатенация строк, \emph{md5} – \emph{md5}-хеш от строки, \emph{aes} — зашифрованный алгоритмом \emph{AES} с помощью
введенного пароля случайно сгенерированный ключ. Полученная строка сохраняется на USB устройство.

В приложении были использованы алгоритмы шифрования библиотеки \emph{openssl}.

\section{Алгоритм расшифровки ключа паролем}
\label{decrypt_key_with_passphrase}
\begin{enumerate}
\item Строка, сохраненная на USB, разбивается на две: \emph{md5}-хеш и зашифрованный ключ.
\item Пользователь вводит пароль.
\item Ключ расшифровывается с помощью пароля (\t{aes\_decrypt}).
\item Вычислить \emph{md5}-хеш от конкатенации пароля и расшифрованного ключа. Если хеш совпадает с ожидаемым, то расшифровка успешна, иначе не успешна.
\end{enumerate}
